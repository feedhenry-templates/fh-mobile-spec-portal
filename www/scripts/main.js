function showErrorPanel(a){var b=$("<div>").addClass("panel panel-danger").append($("<div>").addClass("panel-heading").text("Error")).append($("<div>").addClass("panel-body").text(a));$(".results").empty().append(b)}function loadApp(){$fh.cloud({path:"/recordTest",method:"get",contentType:"application/json"},function(a){$(".spinner").remove();var b=new TestResults(a),c=$(".content")[0],d={removeActive:function(){$(".sidebar-nav li").removeClass("active")},makeActive:function(a){this.removeActive(),$(".sidebar-nav a[href="+a+"]").find("li").addClass("active")}},e=Backbone.Router.extend({routes:{about:"about",help:"help","results/:viewType":"results","result/:reportId":"result","spec/:specId":"spec",charts:"charts","*path":"default"},help:function(){var a=new HelpView({collection:b,el:c});a.render(),d.makeActive("#help")},about:function(){var a=new AboutView({collection:b,el:c});a.render(),d.makeActive("#about")},charts:function(){var a=new TestChartsView({collection:b,el:c});a.render(),d.makeActive("#charts")},results:function(a){var e=new TestResultsView({collection:b,el:c});e.render(a),d.makeActive("#results")},result:function(a){var e=b.get(a);console.log(e);var f=new ResultDetailView({model:e,el:c});f.render(),d.makeActive("#results")},spec:function(a){var e=_.findWhere(b.failedSpecsDetails(),{id:parseInt(a)});console.log(e);var f=new SpecDetailView({el:c});f.render(e),d.makeActive("#results")},resultsByTest:function(){d.makeActive("#resultsByTest")},"default":function(){this.navigate("results/devicesView",{trigger:!0})}}),f=new e;Backbone.history.start(),window.router=f},function(a){showErrorPanel("Failed to load test results. You should find out why. Error : "+a)})}var TestResult=Backbone.Model.extend({idAttribute:"reporterId",failedSpecsMap:null,startTime:function(){var a=this.get("testInfo"),b=_.findWhere(a,{order:0}),c=b.ts;return c},getCompleteInfo:function(){var a=this.get("testInfo"),b=_.findWhere(a,{stage:"complete"});return b},totalSpecs:function(){var a=this.getCompleteInfo();return a?a.data.total_specs:"N/A"},failedSpecs:function(){var a=this.getCompleteInfo();return a?a.data.failed_specs:"N/A"},passedSpecs:function(){var a=this.getCompleteInfo();return a?a.data.passed_specs:"N/A"},skippedSpecs:function(){var a=this.getCompleteInfo();return a?a.data.skipped_specs:"N/A"},specsSummary:function(){return this.getCompleteInfo()?this.failedSpecs()+"/"+this.totalSpecs():"Not Completed"},totalTime:function(){var a=this.get("testInfo"),b=a[0].ts,c=a[a.length-1].ts,d=c-b;return d},mergeFailed:function(a){var b=_.findWhere(a,{stage:"spec_failed"});if(b){var c={};_.each(a,function(a){"spec_failed"===a.stage?(console.log(a),c[a.order]=a.data):"suite_complete"===a.stage&&_.keys(c).length>0&&(a.data.specs=c,c={})})}return a},specsData:function(a){var b=this.mergeFailed(this.get("testInfo")),c={},d=_.filter(b,function(b){return"suite_complete"===b.stage?"boolean"==typeof a?b.data.passed===a||a&&b.data.parents&&0===b.data.parents.length?!0:!1:!0:!1});return _.each(d,function(a){var b=c;if(a.data.parents&&a.data.parents.length>0)for(var d=a.data.parents,e=d.length-1;e>=0;e--){var f=d[e];b[f]||(b[f]={children:{}}),b=b[f].children}b[a.data.suiteId]=b[a.data.suiteId]||{},b[a.data.suiteId].suite_name=a.data.desc||a.data.name,b[a.data.suiteId].total_assertions=a.data.totalCount,b[a.data.suiteId].passed=a.data.passed,b[a.data.suiteId].id=a.data.suiteId,a.data.specs&&(b[a.data.suiteId].specs=a.data.specs)}),console.log(c),c},failedSpecsDetails:function(){var a=this;if(a.failedSpecsMap)return a.failedSpecsMap;var b=this.specsData(!1),c={},d=function(b,e){b.specs&&_.each(b.specs,function(d){d.passed||(d.parentSuites=[].concat(e).concat([b.suite_name]),d.ts=a.startTime(),c[d.desc]||(c[d.desc]=d))}),b.children&&(e=e.concat([b.suite_name]),_.each(b.children,function(a){d(a,e)}))};return _.each(b,function(a){d(a,[])}),a.failedSpecsMap=c,a.failedSpecsMap}}),TestResults=Backbone.Collection.extend({model:TestResult,allFailedSpecs:null,_colourForKey:function(a){if("win32nt"===a.toLowerCase())return"#fb9d00";if("blackberry"===a.toLowerCase())return"#df3f1f";if("ios"===a.toLowerCase())return"#666666";if("android"===a.toLowerCase())return"#7bb900";if("studio"===a.toLowerCase())return"#3d96ae";if("ipad"===a.toLowerCase())return"#aa4643";if("ios"===a.toLowerCase())return"#484848";if("embed"===a.toLowerCase())return"#4572a7";if("fhc"===a.toLowerCase())return"#492970";if("web"===a.toLowerCase())return"#92A8CD";if("mobile"===a.toLowerCase())return"#80699B";if(""===a.toLowerCase())return"#db843d";var b=["#aa4643","#80699b","#db843d","#4572A7","#AA4643","#89A54E","#3D96AE","#DB843D","#A47D7C","#B5CA92"],c=b[Math.floor(Math.random()*b.length)];return c},_filterDeviceInfo:function(a){var b={};this.each(function(c){var d=c.get("deviceInfo"),e=d[a];if(_.has(b,e)){var f=b[e];b[e]={value:f.value+=1,label:f.label}}else b[e]={value:1,label:e}},this);var c=[];return _.each(b,function(a,b){var d=this._colourForKey(b);c.push({value:a.value,label:b,color:d,highlight:d})},this),c},byOS:function(){return this._filterDeviceInfo("platform")},byCordova:function(){return this._filterDeviceInfo("cordova")},byDevice:function(){return this._filterDeviceInfo("model")},failedSpecsDetails:function(){var a=this;if(a.allFailedSpecs)return a.allFailedSpecs;var b={};this.each(function(c){var d=c.failedSpecsDetails();_.each(d,function(d,e){b[e]||(b[e]={failureCount:0,devices:[],lastFail:-1}),b[e].failureCount++,d.ts&&d.ts>b[e].lastFail&&(b[e].lastFail=d.ts);var f=a.deviceExists(b[e].devices,c.get("deviceInfo"));if(f)f.tests[c.get("reporterId")]||(f.tests[c.get("reporterId")]={reporterId:c.get("reporterId"),result:c.specsSummary(),ts:d.ts});else{var g=_.clone(c.get("deviceInfo"));g.tests={},g.tests[c.get("reporterId")]={reporterId:c.get("reporterId"),result:c.specsSummary(),ts:d.ts},b[e].devices.push(g)}})});var c=[];return _.each(b,function(a,b){var d=a;d.id=c.length,a.specName=b,c.push(d)}),a.allFailedSpecs=c,console.log(c),a.allFailedSpecs},deviceExists:function(a,b){var c=_.findWhere(a,b);return c}}),TestResultsView=Backbone.View.extend({template:"#results-template",events:{"click .devices-view-btn":"renderDevicesView","click .tests-view-btn":"renderTestsView"},renderDevicesView:function(){window.router.navigate("results/devicesView",{trigger:!0})},renderTestsView:function(){window.router.navigate("results/testsView",{trigger:!0})},getDevicesViewTableData:function(){var a=this;return{data:a.collection.toJSON(),paging:!0,pageLength:10,order:[6,"desc"],sDom:'<"top">rt<"bottom"lp><"clear">',columns:[{data:"reporterId",visible:!1},{title:"Device",data:"deviceInfo.platform"},{title:"OS Version",data:"deviceInfo.version"},{title:"UUID",data:"deviceInfo.uuid"},{title:"Device Model",data:"deviceInfo.model"},{title:"Cordova Version",data:"deviceInfo.cordova"},{title:"Test Time",type:"num",data:function(a,b){if("display"===b){if(!a.ts_text){var c=a.testInfo,d=_.findWhere(c,{order:0}),e=d.ts;a.ts=e,a.ts_text=moment(e).fromNow()}return a.ts_text}return a.ts}},{title:"Test Results (Failed/Total)",data:function(a){var b=new TestResult(a);return b.specsSummary()}}]}},getTestsViewTableData:function(){var a=this.collection.failedSpecsDetails();return{data:a,paging:!0,pageLength:10,order:[2,"desc"],sDom:'<"top">rt<"bottom"lp><"clear">',columns:[{title:"Spec Name",data:"specName",width:"55%"},{title:"Failures",data:"failureCount",width:"5%"},{title:"Last Failure",type:"num",width:"15%",data:function(a,b){return"display"===b?moment(a.lastFail).fromNow():a.lastFail}},{title:"Devices",data:function(a){var b=_.map(a.devices,function(a){return[a.platform,a.version,"("+a.cordova+")"].join(" ")});return b.join(",")}}]}},render:function(a){var b=this,c=$(this.template).html();$(this.el).html(c);var d=".devices-view-btn",e=this.getDevicesViewTableData();"testsView"===a&&(d=".tests-view-btn",e=this.getTestsViewTableData()),$(this.el).find(".meta .btn-group .active").removeClass("active"),$(this.el).find(d).addClass("active");var f=b.$el.find("table"),g=f.DataTable(e);$("input.search").unbind().on("keyup",function(a){var b=$(a.currentTarget).val();g.search(b).draw()}),f.find("tbody").on("click","tr",function(){var b=g.row(this).data();"testsView"===a?window.router.navigate("spec/"+b.id,{trigger:!0}):window.router.navigate("result/"+b.reporterId,{trigger:!0})})}}),ResultDetailView=Backbone.View.extend({template:"#result-detail-template",events:{"click .specs-counters":"filterSpecs"},getSpecsData:function(){var a=this.model.totalSpecs(),b=this.model.passedSpecs(),c=this.model.failedSpecs(),d=this.model.skippedSpecs();return[{type:"info",title:"Total",content:a},{type:"success",title:"Passed",content:b},{type:"danger",title:"Failed",content:c},{type:"default",title:"Skipped",content:d}]},render:function(){var a=Math.ceil(moment.duration(this.model.totalTime()).asSeconds()),b={summary_data:this.getSpecsData(),device:this.model.get("deviceInfo"),duration:a},c=$(this.template).html(),d=Handlebars.compile(c);$(this.el).html(d(b)),this.renderSuites()},renderSuites:function(a){var b=this,c=this.model.specsData(a),d=['<ul class="timeline">'];_.each(c,function(c){b.renderSuitesView(c,d,a)}),d.push("</ul>"),$(this.el).find(".result-detail-timeline").html(d.join(""))},renderSuitesView:function(a,b,c){var d=this;b.push('<li class="timeline-inverted">');var e=a.passed?"success":"danger",f=a.passed?"fa-check":"fa-times";b.push('<div class="timeline-badge '+e+'">'),b.push('<i class="fa '+f+'"></i>'),b.push("</div>"),b.push('<div class="timeline-panel">'),b.push('<div class="timeline-heading">'),b.push('<h4 class="timeline-title">'),b.push('<a data-toggle="collapse" href="#suite_'+a.id+'">'),b.push(a.suite_name),b.push("</a>"),b.push("</h4>"),b.push("</div>"),b.push('<div id="suite_'+a.id+'" class="panel-collaps collapse">'),b.push('<div class="timeline-body">'),a.specs&&_.each(a.specs,function(a){"boolean"==typeof c?c===a.passed&&d.renderSpecView(a,b):d.renderSpecView(a,b)}),a.children&&(b.push('<ul class="timeline">'),_.each(a.children,function(a){d.renderSuitesView(a,b,c)}),b.push("</ul>")),b.push("</div>"),b.push("</div>"),b.push("</div>"),b.push("</li>")},renderSpecView:function(a,b){var c=a.passed?"panel-success":"panel-danger",d=a.passed?"fa-check":"fa-times";b.push('<div class="panel '+c+'">'),b.push('<div class="panel-heading">'),b.push('<i class="fa '+d+'"></i> '),b.push(a.desc),b.push("</div>"),a.passed||(b.push('<div class="panel-body">'),_.each(a.resultData||a.results,function(a){if(a){b.push("<p>");var c=a.stackTrace?a.stackTrace.replace(/\n/g,"<br/>"):a.message?a.message:"N/A";b.push(c),b.push("</p>")}}),b.push("</div>")),b.push("</div>")},filterSpecs:function(a){var b=$(a.currentTarget),c=null;b.hasClass("success")&&(c=!0),b.hasClass("danger")&&(c=!1),this.renderSuites(c)}}),SpecDetailView=Backbone.View.extend({template:"#spec-detail-template",render:function(a){var b=$(this.template).html();Handlebars.registerHelper("fromNow",function(a){return moment(a).fromNow()});var c=Handlebars.compile(b);$(this.el).html(c(a))}}),TestChartsView=Backbone.View.extend({template:"#charts-template",render:function(){var a=$(this.template).html();$(this.el).html(a),this.renderOS(),this.renderCordova(),this.renderDevice()},renderOS:function(){{var a=this.$el.find("#os"),b=this.collection.byOS(),c=a.get(0).getContext("2d");new Chart(c).Doughnut(b,this.doughnutOptions)}},renderCordova:function(){{var a=this.$el.find("#cordova_version"),b=this.collection.byCordova(),c=a.get(0).getContext("2d");new Chart(c).Doughnut(b,this.doughnutOptions)}},renderDevice:function(){{var a=this.$el.find("#model"),b=this.collection.byDevice(),c=a.get(0).getContext("2d");new Chart(c).Doughnut(b,this.doughnutOptions)}}}),AboutView=Backbone.View.extend({template:"#about-template",render:function(){var a=$(this.template).html();$(this.el).html(a)}}),HelpView=Backbone.View.extend({template:"#help-template",render:function(){var a=$(this.template).html();$(this.el).html(a)}}),initcalled=!1;$(document).ready(function(){$(".spinner").spin(),$fh.on("fhinit",function(a){initcalled=!0,a?showErrorPanel("FH SDK failed to init. Something is wrong..."):loadApp()}),setTimeout(function(){initcalled||showErrorPanel("FH SDK failed to init in 5 seconds. You should find out why...")},5e3)});